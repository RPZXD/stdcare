<?php
session_start();
if (!isset($_SESSION['Student_login'])) {
    echo '<div class="text-red-500">ไม่ได้รับอนุญาต</div>';
    exit;
}

require_once('../../config/Database.php');
require_once('../../class/EQ.php');

$student_id = $_GET['stuId'] ?? null;
$pee = $_GET['pee'] ?? null;
$term = $_GET['term'] ?? null;

if (!$student_id || !$pee || !$term) {
    echo '<div class="text-red-500">ไม่พบข้อมูลที่ต้องการ</div>';
    exit;
}

$db = new Database("phichaia_student");
$conn = $db->getConnection();
$eq = new EQ($conn);

$data = $eq->getEQData($student_id, $pee, $term);

if (!$data) {
    echo '<div class="text-red-500">ยังไม่มีการบันทึกข้อมูล EQ สำหรับปีการศึกษาและภาคเรียนนี้</div>';
    exit;
}
?>

<?php
// List of EQ questions (เหมือนใน form_eq_edit.php)
$questions = [
    ['q1', 'ฉันเข้าใจความรู้สึกของตัวเองเวลาที่โกรธ เสียใจ หรือดีใจ', 'รู้จักและเข้าใจตนเอง'],
    ['q2', 'ฉันสามารถบอกความรู้สึกของตัวเองได้เมื่อมีอารมณ์ต่าง ๆ', 'รู้จักและเข้าใจตนเอง'],
    ['q3', 'ฉันเห็นข้อดีและข้อเสียของตนเองได้ชัดเจน', 'รู้จักและเข้าใจตนเอง'],
    ['q4', 'ฉันเชื่อมั่นในความสามารถของตนเอง', 'รู้จักและเข้าใจตนเอง'],
    ['q5', 'ฉันยอมรับในสิ่งที่ตนเองเป็นได้', 'รู้จักและเข้าใจตนเอง'],
    ['q6', 'ฉันสามารถควบคุมอารมณ์ของตนเองเมื่อไม่พอใจ', 'การควบคุมอารมณ์'],
    ['q7', 'ฉันใจเย็นเมื่อมีปัญหาเกิดขึ้น', 'การควบคุมอารมณ์'],
    ['q8', 'ฉันอดทนต่อสิ่งเร้าที่ไม่พึงประสงค์ได้ดี', 'การควบคุมอารมณ์'],
    ['q9', 'ฉันไม่แสดงอารมณ์รุนแรงเมื่อมีความขัดแย้ง', 'การควบคุมอารมณ์'],
    ['q10', 'ฉันสามารถให้อภัยผู้อื่นได้เมื่อเขาทำผิด', 'การควบคุมอารมณ์'],
    ['q11', 'ฉันมีความตั้งใจในการเรียน', 'การมีแรงจูงใจ'],
    ['q12', 'ฉันพยายามทำสิ่งต่าง ๆ ให้สำเร็จแม้จะยาก', 'การมีแรงจูงใจ'],
    ['q13', 'ฉันไม่ยอมแพ้ง่าย ๆ เมื่อเจออุปสรรค', 'การมีแรงจูงใจ'],
    ['q14', 'ฉันมีเป้าหมายในชีวิต', 'การมีแรงจูงใจ'],
    ['q15', 'ฉันรู้สึกภูมิใจเมื่อทำสิ่งดี ๆ ได้สำเร็จ', 'การมีแรงจูงใจ'],
    ['q16', 'ฉันเข้าใจความรู้สึกของผู้อื่นได้เมื่อเขาเศร้า', 'การเห็นอกเห็นใจผู้อื่น'],
    ['q17', 'ฉันสามารถแสดงความเห็นใจเมื่อเพื่อนมีปัญหา', 'การเห็นอกเห็นใจผู้อื่น'],
    ['q18', 'ฉันช่วยเหลือผู้อื่นโดยไม่หวังผลตอบแทน', 'การเห็นอกเห็นใจผู้อื่น'],
    ['q19', 'ฉันเสียใจเมื่อเห็นผู้อื่นเดือดร้อน', 'การเห็นอกเห็นใจผู้อื่น'],
    ['q20', 'ฉันยินดีช่วยเหลือเพื่อนที่อ่อนแอกว่า', 'การเห็นอกเห็นใจผู้อื่น'],
    ['q21', 'ฉันพูดจาสุภาพกับผู้อื่น', 'ทักษะทางสังคม'],
    ['q22', 'ฉันมีน้ำใจและแบ่งปันสิ่งของกับเพื่อน', 'ทักษะทางสังคม'],
    ['q23', 'ฉันทำงานร่วมกับผู้อื่นได้ดี', 'ทักษะทางสังคม'],
    ['q24', 'ฉันเคารพกฎระเบียบของกลุ่มหรือโรงเรียน', 'ทักษะทางสังคม'],
    ['q25', 'ฉันยอมรับความคิดเห็นของผู้อื่นแม้จะแตกต่าง', 'ทักษะทางสังคม'],
    ['q26', 'ฉันกล้าแสดงออกอย่างเหมาะสม', 'รู้จักและเข้าใจตนเอง'],
    ['q27', 'ฉันสามารถรับฟังความคิดเห็นของผู้อื่นได้ดี', 'ทักษะทางสังคม'],
    ['q28', 'ฉันวางแผนและจัดการเวลาได้เหมาะสม', 'การมีแรงจูงใจ'],
    ['q29', 'ฉันสามารถปรับตัวเข้ากับผู้อื่นได้ง่าย', 'ทักษะทางสังคม'],
    ['q30', 'ฉันไม่เก็บความเครียดไว้นาน', 'การควบคุมอารมณ์'],
    ['q31', 'ฉันเปิดใจยอมรับการเปลี่ยนแปลง', 'รู้จักและเข้าใจตนเอง'],
    ['q32', 'ฉันขอโทษเมื่อทำผิด', 'การเห็นอกเห็นใจผู้อื่น'],
    ['q33', 'ฉันขอบคุณเมื่อได้รับความช่วยเหลือ', 'ทักษะทางสังคม'],
    ['q34', 'ฉันสามารถพูดคุยกับผู้ใหญ่ได้อย่างมั่นใจ', 'รู้จักและเข้าใจตนเอง'],
    ['q35', 'ฉันกล้าตัดสินใจในเรื่องที่เหมาะสม', 'การมีแรงจูงใจ'],
    ['q36', 'ฉันสามารถขอความช่วยเหลือจากผู้อื่นได้เมื่อจำเป็น', 'ทักษะทางสังคม'],
    ['q37', 'ฉันยอมรับผลจากการกระทำของตนเอง', 'รู้จักและเข้าใจตนเอง'],
    ['q38', 'ฉันเรียนรู้จากความผิดพลาดของตนเอง', 'การควบคุมอารมณ์'],
    ['q39', 'ฉันมีกำลังใจที่จะทำสิ่งดี ๆ ต่อไป', 'การมีแรงจูงใจ'],
    ['q40', 'ฉันใช้คำพูดที่ให้กำลังใจผู้อื่น', 'การเห็นอกเห็นใจผู้อื่น'],
    ['q41', 'ฉันรู้สึกดีกับตัวเองเมื่อทำสิ่งดี ๆ ให้ผู้อื่น', 'รู้จักและเข้าใจตนเอง'],
    ['q42', 'ฉันรู้จักเลือกคบเพื่อนที่เหมาะสม', 'ทักษะทางสังคม'],
    ['q43', 'ฉันอดทนต่อคำวิจารณ์ได้ดี', 'การควบคุมอารมณ์'],
    ['q44', 'ฉันไม่ตัดสินผู้อื่นจากภายนอก', 'การเห็นอกเห็นใจผู้อื่น'],
    ['q45', 'ฉันรับฟังปัญหาของเพื่อนได้อย่างตั้งใจ', 'การเห็นอกเห็นใจผู้อื่น'],
    ['q46', 'ฉันสามารถอธิบายความต้องการของตนเองได้ชัดเจน', 'รู้จักและเข้าใจตนเอง'],
    ['q47', 'ฉันไม่โทษผู้อื่นเมื่อเกิดปัญหา', 'การควบคุมอารมณ์'],
    ['q48', 'ฉันจัดการความเครียดได้ด้วยกิจกรรมที่ชอบ', 'การควบคุมอารมณ์'],
    ['q49', 'ฉันมีวิธีจัดการกับความไม่พอใจได้ดี', 'การควบคุมอารมณ์'],
    ['q50', 'ฉันสามารถยอมรับความแตกต่างของผู้อื่นได้', 'การเห็นอกเห็นใจผู้อื่น'],
    ['q51', 'ฉันกล้าปฏิเสธเมื่อถูกชักชวนให้ทำสิ่งไม่ดี', 'ทักษะทางสังคม'],
    ['q52', 'ฉันสามารถปรับอารมณ์ให้กลับมาสงบได้เร็ว', 'การควบคุมอารมณ์'],
];

// ตัวเลือกคำตอบ
$choices = [
    '0' => '❌ ไม่จริง',
    '1' => '😐 จริงบางครั้ง',
    '2' => '🙂 ค่อนข้างจริง',
    '3' => '✅ จริงมาก',
];
?>

<div class="space-y-4">
    <h4 class="font-semibold text-lg mb-2">คำตอบแบบประเมิน EQ</h4>
    <table class="w-full border-collapse border border-gray-300">
        <thead>
            <tr class="bg-blue-500 text-white text-center">
                <th class="border px-4 py-2">ข้อ</th>
                <th class="border px-4 py-2">รายการประเมิน</th>
                <th class="border px-4 py-2">กลุ่ม</th>
                <th class="border px-4 py-2">คำตอบ</th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($questions as $index => [$id, $text, $category]): ?>
                <tr class="hover:bg-gray-50">
                    <td class="border px-4 py-2 text-center"><?= $index + 1 ?></td>
                    <td class="border px-4 py-2"><?= htmlspecialchars($text) ?></td>
                    <td class="border px-4 py-2 text-sm text-gray-500"><?= $category ?></td>
                    <td class="border px-4 py-2">
                        <div class="flex flex-col sm:flex-row gap-2">
                            <?php foreach ($choices as $value => $label): 
                                $checked = (isset($data['EQ'.($index+1)]) && $data['EQ'.($index+1)] == $value);
                            ?>
                                <label class="inline-flex items-center gap-2 px-2 py-1 rounded-md <?= $checked ? 'bg-blue-200 font-bold' : 'text-gray-400' ?>">
                                    <input type="radio" disabled <?= $checked ? 'checked' : '' ?>>
                                    <span><?= $label ?></span>
                                </label>
                            <?php endforeach; ?>
                        </div>
                    </td>
                </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
</div>
